<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Robot Observation Stream (Alpine.js Refactor - Dark Theme)</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <!-- Socket.IO -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js"></script>
  <!-- Alpine.js -->
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body
  class="bg-gray-900 text-gray-200 min-h-screen"
  x-data="robotApp()"
  x-init="initSocket()"
  x-on:keydown.window.arrow-right="handleKey('ArrowRight')"
  x-on:keydown.window.arrow-left="handleKey('ArrowLeft')"
  x-on:keydown.window.escape="handleKey('Escape')"
  x-on:keydown.window.space="toggleReward()"
>
  
  <!-- Header Bar -->
  <div class="bg-gray-800 text-gray-200 p-4 flex justify-between items-center shadow-lg">
    <div class="flex space-x-6">
      <!-- Mode -->
      <div class="flex items-center space-x-2">
        <span class="text-gray-400">Mode:</span>
        <span class="font-mono" x-text="configData.control_phase ?? '-'">-</span>
      </div>
      <!-- Episode -->
      <div class="flex items-center space-x-2">
        <span class="text-gray-400">Episode:</span>
        <span
          class="font-mono"
          x-text="
            (configData.current_episode !== undefined && configData.num_episodes !== undefined)
              ? ((configData.current_episode + 1) + '/' + configData.num_episodes)
              : '-'
          "
        >
        -
      </span>
      </div>
      <!-- Reward -->
      <div class="flex items-center space-x-2">
        <span class="text-gray-400">Reward:</span>
        <span
          class="font-mono bg-gray-700 px-2 py-1 rounded"
          x-text="eventsData.next_reward ?? '-'"
        >
          -
        </span>
      </div>
      <!-- Time Remaining -->
      <div class="flex items-center space-x-2">
        <span class="text-gray-400">Time Remaining:</span>
        <span
          class="font-mono bg-red-700 px-2 py-1 rounded"
          x-text="countdownText"
        >
          00:00
        </span>
      </div>
    </div>
    <!-- Last Timestamp -->
    <div id="timestamp" class="font-mono text-gray-400" x-text="timestamp"></div>
  </div>
  
  <!-- Main Container -->
  <div class="container mx-auto p-6 flex flex-col lg:flex-row gap-6">
    <!-- Left Panel -->
    <div class="lg:w-2/3 space-y-6">
      <!-- Camera Grid -->
      <div
        id="cameras"
        class="grid grid-cols-1 md:grid-cols-2 gap-4"
      >
        <!-- Loop over images object -->
        <template x-for="(imageData, name) in images" :key="name">
          <div class="bg-gray-800 rounded-lg shadow-md p-4">
            <h3 class="text-lg font-semibold mb-2 text-gray-300" x-text="name"></h3>
            <!-- For simplicity, using an <img> tag. If you must use <canvas>, see the note below. -->
            <img
              class="w-full border border-gray-700 rounded"
              :src="`data:image/jpeg;base64,${imageData}`"
              alt=""
            />
          </div>
        </template>
      </div>
    </div>
    
    <!-- Right Panel -->
    <div class="lg:w-1/3 space-y-6">
      <!-- State Panel -->
      <div class="bg-gray-800 rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4 text-gray-300">Robot State</h3>
        <div id="state-values" class="space-y-2">
          <template x-for="(valObj, key) in stateData" :key="key">
            <div class="font-mono text-sm">
              <!-- Arrays -->
              <template x-if="Array.isArray(valObj.data)">
                <span
                  x-text="`${key}: [${valObj.data.map(v => v.toFixed(4)).join(', ')}]`"
                ></span>
              </template>
              <!-- Single values -->
              <template x-if="!Array.isArray(valObj.data)">
                <span x-text="`${key}: [${valObj.data.toFixed(4)}]`"></span>
              </template>
            </div>
          </template>
        </div>
      </div>
      
      <!-- Config Panel -->
      <div class="bg-gray-800 rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4 text-gray-300">Configuration</h3>
        <div id="config-values" class="space-y-2">
          <template x-for="(value, key) in configData" :key="key">
            <div class="font-mono text-sm">
              <span
                x-text="
                  key === 'current_episode'
                    ? `${key}: ${value + 1}`
                    : `${key}: ${value}`
                "
              ></span>
            </div>
          </template>
          
        </div>
      </div>
      
      <!-- Controls Panel -->
      <div class="bg-gray-800 rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-6 text-gray-300 flex items-center">
          Controls
        </h3>
        <div class="space-y-3">
          <!-- Voice Control -->
          <button
            class="flex items-center justify-between w-full px-6 py-3 rounded-lg transition-all duration-200 transform hover:scale-[1.02]"
            :class="voiceEnabled ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-200'"
            @click="toggleVoice"
          >
            <span class="flex items-center">
              <i class="mr-3 text-lg" :class="voiceEnabled ? 'fas fa-microphone' : 'fas fa-microphone-slash'"></i>
              <span x-text="voiceEnabled ? 'Disable Voice' : 'Enable Voice'"></span>
            </span>
            <i class="fas fa-chevron-right opacity-50"></i>
          </button>

          <!-- Exit Early -->
          <button
            class="flex items-center justify-between w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all duration-200 transform hover:scale-[1.02]"
            @click="handleKey('ArrowRight')"
          >
            <span class="flex items-center">
              <i class="fas fa-arrow-right mr-3 text-lg"></i>
              Exit Early
            </span>
            <i class="fas fa-chevron-right opacity-50"></i>
          </button>

          <!-- Rerecord -->
          <button
            class="flex items-center justify-between w-full px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-all duration-200 transform hover:scale-[1.02]"
            @click="handleKey('ArrowLeft')"
          >
            <span class="flex items-center">
              <i class="fas fa-undo mr-3 text-lg"></i>
              Rerecord
            </span>
            <i class="fas fa-chevron-right opacity-50"></i>
          </button>

          <!-- Stop -->
          <button
            class="flex items-center justify-between w-full px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all duration-200 transform hover:scale-[1.02]"
            @click="handleKey('Escape')"
          >
            <span class="flex items-center">
              <i class="fas fa-stop mr-3 text-lg"></i>
              Stop
            </span>
            <i class="fas fa-chevron-right opacity-50"></i>
          </button>

          <!-- Toggle Reward -->
          <button
            class="flex items-center justify-between w-full px-6 py-3 rounded-lg transition-all duration-200 transform hover:scale-[1.02]"
            :class="rewardEnabled ? 'bg-yellow-600 hover:bg-yellow-700 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-200'"
            @click="toggleReward"
          >
            <span class="flex items-center">
              <i class="mr-3 text-lg" :class="rewardEnabled ? 'fas fa-star' : 'fas fa-star-half-alt'"></i>
              <span x-text="rewardEnabled ? 'Disable Reward' : 'Enable Reward'"></span>
            </span>
            <i class="fas fa-chevron-right opacity-50"></i>
          </button>
        </div>
      </div>

      <!-- Log Panel -->
      <div class="bg-gray-800 rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4 text-gray-300">Logs</h3>
        <div id="log-items" class="space-y-2">
          <template x-for="(log, idx) in logs" :key="idx">
            <div class="font-mono text-sm">
              <span class="text-gray-400" x-text="log.name + ':'"></span>
              <span class="text-white" x-text="log.value.toFixed(2)"></span>
              <span class="text-gray-400" x-text="log.unit"></span>
            </div>
          </template>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('robotApp', () => ({
        // Reactive state
        configData: {},
        stateData: {},
        eventsData: {},
        logs: [],
        images: {},
        countdownTime: 0,
        timestamp: '',
        voiceEnabled: false,
        rewardEnabled: false,
        
        // Computed-like property for displaying the countdown
        get countdownText() {
          const minutes = Math.floor(this.countdownTime / 60);
          const secs = Math.floor(this.countdownTime % 60);
          return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        },

        initSocket() {
          this.socket = io({
            reconnection: true,
            reconnectionAttempts: Infinity,      // Unlimited reconnection attempts
            reconnectionDelay: 1000,             // Start with 1 second delay
            reconnectionDelayMax: 5000,          // Max delay of 5 seconds
            randomizationFactor: 0.5
          });

          this.socket.on('connect', () => {
            console.log('Connected to server');
          });
          this.socket.on('disconnect', () => {
            console.log('Disconnected from server');
            this.resetData();
          });
          this.socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
          });

          this.socket.on('observation_update', (data) => {
            if (data.timestamp) {
              this.timestamp = `Last Update: ${this.formatTimestamp(data.timestamp)}`;
            }
            if (data.config) {
              this.updateConfig(data.config);
            }
            if (data.state) {
              this.stateData = data.state;
            }
            if (data.events) {
              this.eventsData = data.events;
            }
            if (data.log_items) {
              this.logs = data.log_items;
            }
            if (data.images) {
              this.images = data.images;
            }
            if (data.countdown_time !== undefined) {
              this.countdownTime = data.countdown_time;
            }
          });

          this.socket.on('config_update', (data) => {
            if (data.config) {
              this.updateConfig(data.config);
            }
            if (data.timestamp) {
              this.timestamp = `Config Updated: ${this.formatTimestamp(data.timestamp)}`;
            }
          });

          this.socket.on('log_say', (data) => {
            this.speakMessage(data.message);
          });
        },

        // Merge config data
        updateConfig(newConfig) {
          this.configData = { ...this.configData, ...newConfig };
        },

        // Handle special keys
        handleKey(key) {
          console.log(`${key} pressed.`);
          // Forward the key event to the server
          this.socket.emit('keydown_event', { key });
        },

        // Reset the UI upon disconnect
        resetData() {
          this.configData = {};
          this.stateData = {};
          this.eventsData = {};
          this.logs = [];
          this.images = {};
          this.countdownTime = 0;
          this.timestamp = '';
        },

        formatTimestamp(tsSeconds) {
          return new Date(tsSeconds * 1000).toISOString();
        },

        toggleVoice() {
          this.voiceEnabled = !this.voiceEnabled;
          if (this.voiceEnabled) {
            this.enableVoice();
          } else {
            this.disableVoice();
          }
        },

        toggleReward() {
          this.rewardEnabled = !this.rewardEnabled;
          // Emit the appropriate key event or handle reward toggle logic here
          this.handleKey('Space');
        },

        enableVoice() {
          this.loadVoices().then(() => {
            this.speakMessage('Voice is now enabled!');
          });
        },

        disableVoice() {
          // Implement voice disabling logic if necessary
          // For example, stop any ongoing speech
          if (speechSynthesis.speaking) {
            speechSynthesis.cancel();
          }
          this.speakMessage('Voice is now disabled!');
        },

        loadVoices() {
          return new Promise((resolve) => {
            let voices = speechSynthesis.getVoices();
            if (voices.length > 0) {
              resolve(voices);
            } else {
              speechSynthesis.onvoiceschanged = () => {
                voices = speechSynthesis.getVoices();
                resolve(voices);
              };
            }
          });
        },

        speakMessage(message) {
          this.loadVoices().then(() => {
            const utterance = new SpeechSynthesisUtterance(message);
            speechSynthesis.speak(utterance);
          });
        },
      }));
    });
  </script>
</body>
</html>
